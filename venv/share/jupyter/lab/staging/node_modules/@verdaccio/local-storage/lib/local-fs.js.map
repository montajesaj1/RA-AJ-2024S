{"version":3,"file":"local-fs.js","names":["_fs","_interopRequireDefault","require","_path","_debug","_lodash","_mkdirp","_streams","_fileLocking","_commonsApi","obj","__esModule","default","fileExist","exports","noSuchFile","resourceNotAvailable","pkgFileName","debug","buildDebug","fSError","message","code","err","getCode","tempFile","str","String","Math","random","substr","renameTmp","src","dst","_cb","cb","fs","unlink","process","platform","rename","tmp","LocalFS","constructor","path","logger","updatePackage","name","updateHandler","onWrite","transformPackage","onEnd","_lockAndReadJSON","json","locked","self","unLockCallback","lockError","_args","arguments","_unlockJSON","apply","_","isNil","getInternalError","getNotFound","deletePackage","packageName","callback","_getStorage","removePackage","rmdir","createPackage","value","_createFile","_convertToString","savePackage","_writeFile","readPackage","_readStorageFile","then","res","data","JSON","parse","toString","writeTarball","uploadStream","UploadTarball","_ended","on","pathName","access","fileNotFound","exists","emit","temporalName","join","replace","file","createWriteStream","removeTempFile","opened","pipe","done","onend","end","abort","readTarball","readTarballStream","ReadTarball","readStream","createReadStream","fd","fstat","stats","size","close","contents","open","Promise","resolve","reject","readFile","stringify","fileName","storagePath","dest","createTempFile","tempFilePath","writeFile","mkdirp","dirname","catch","lock","unlockFile"],"sources":["../src/local-fs.ts"],"sourcesContent":["/* eslint-disable no-undef */\n\nimport fs from 'fs';\nimport path from 'path';\n\nimport buildDebug from 'debug';\nimport _ from 'lodash';\nimport mkdirp from 'mkdirp';\nimport { UploadTarball, ReadTarball } from '@verdaccio/streams';\nimport { unlockFile, readFile } from '@verdaccio/file-locking';\nimport { Callback, Logger, Package, ILocalPackageManager, IUploadTarball } from '@verdaccio/legacy-types';\nimport { getCode, getInternalError, getNotFound, VerdaccioError } from '@verdaccio/commons-api';\n\nexport const fileExist = 'EEXISTS';\nexport const noSuchFile = 'ENOENT';\nexport const resourceNotAvailable = 'EAGAIN';\nexport const pkgFileName = 'package.json';\n\nconst debug = buildDebug('verdaccio:plugin:local-storage:fs');\n\nexport const fSError = function(message: string, code = 409): VerdaccioError {\n  const err: VerdaccioError = getCode(code, message);\n  // FIXME: we should return http-status codes here instead, future improvement\n  // @ts-ignore\n  err.code = message;\n\n  return err;\n};\n\nconst tempFile = function(str): string {\n  return `${str}.tmp${String(Math.random()).substr(2)}`;\n};\n\nconst renameTmp = function(src, dst, _cb): void {\n  const cb = (err): void => {\n    if (err) {\n      fs.unlink(src, () => {});\n    }\n    _cb(err);\n  };\n\n  if (process.platform !== 'win32') {\n    return fs.rename(src, dst, cb);\n  }\n\n  // windows can't remove opened file,\n  // but it seem to be able to rename it\n  const tmp = tempFile(dst);\n  fs.rename(dst, tmp, function(err) {\n    fs.rename(src, dst, cb);\n    if (!err) {\n      fs.unlink(tmp, () => {});\n    }\n  });\n};\n\nexport type ILocalFSPackageManager = ILocalPackageManager & { path: string };\n\nexport default class LocalFS implements ILocalFSPackageManager {\n  public path: string;\n  public logger: Logger;\n\n  public constructor(path: string, logger: Logger) {\n    this.path = path;\n    this.logger = logger;\n  }\n\n  /**\n    *  This function allows to update the package thread-safely\n      Algorithm:\n      1. lock package.json for writing\n      2. read package.json\n      3. updateFn(pkg, cb), and wait for cb\n      4. write package.json.tmp\n      5. move package.json.tmp package.json\n      6. callback(err?)\n    * @param {*} name\n    * @param {*} updateHandler\n    * @param {*} onWrite\n    * @param {*} transformPackage\n    * @param {*} onEnd\n    */\n  public updatePackage(\n    name: string,\n    updateHandler: Callback,\n    onWrite: Callback,\n    transformPackage: Function,\n    onEnd: Callback\n  ): void {\n    this._lockAndReadJSON(pkgFileName, (err, json) => {\n      let locked = false;\n      const self = this;\n      // callback that cleans up lock first\n      const unLockCallback = function(lockError: Error): void {\n        // eslint-disable-next-line prefer-rest-params\n        const _args = arguments;\n\n        if (locked) {\n          self._unlockJSON(pkgFileName, () => {\n            // ignore any error from the unlock\n            if (lockError !== null) {\n              debug('lock file: %o has failed with error %o', name, lockError);\n            }\n\n            onEnd.apply(lockError, _args);\n          });\n        } else {\n          debug('file: %o has been updated', name);\n          onEnd(..._args);\n        }\n      };\n\n      if (!err) {\n        locked = true;\n        debug('file: %o has been locked', name);\n      }\n\n      if (_.isNil(err) === false) {\n        if (err.code === resourceNotAvailable) {\n          return unLockCallback(getInternalError('resource temporarily unavailable'));\n        } else if (err.code === noSuchFile) {\n          return unLockCallback(getNotFound());\n        } else {\n          return unLockCallback(err);\n        }\n      }\n\n      updateHandler(json, err => {\n        if (err) {\n          return unLockCallback(err);\n        }\n\n        onWrite(name, transformPackage(json), unLockCallback);\n      });\n    });\n  }\n\n  public deletePackage(packageName: string, callback: (err: NodeJS.ErrnoException | null) => void): void {\n    debug('delete a package %o', packageName);\n\n    return fs.unlink(this._getStorage(packageName), callback);\n  }\n\n  public removePackage(callback: (err: NodeJS.ErrnoException | null) => void): void {\n    debug('remove a package %o', this.path);\n\n    fs.rmdir(this._getStorage('.'), callback);\n  }\n\n  public createPackage(name: string, value: Package, cb: Callback): void {\n    debug('create a package %o', name);\n\n    this._createFile(this._getStorage(pkgFileName), this._convertToString(value), cb);\n  }\n\n  public savePackage(name: string, value: Package, cb: Callback): void {\n    debug('save a package %o', name);\n\n    this._writeFile(this._getStorage(pkgFileName), this._convertToString(value), cb);\n  }\n\n  public readPackage(name: string, cb: Callback): void {\n    debug('read a package %o', name);\n\n    this._readStorageFile(this._getStorage(pkgFileName)).then(\n      res => {\n        try {\n          const data: any = JSON.parse(res.toString('utf8'));\n\n          debug('read storage file %o has succeed', name);\n          cb(null, data);\n        } catch (err) {\n          debug('parse storage file %o has failed with error %o', name, err);\n          cb(err);\n        }\n      },\n      err => {\n        debug('read storage file %o has failed with error %o', name, err);\n\n        return cb(err);\n      }\n    );\n  }\n\n  public writeTarball(name: string): IUploadTarball {\n    const uploadStream = new UploadTarball({});\n    debug('write a tarball for a package %o', name);\n\n    let _ended = 0;\n    uploadStream.on('end', function() {\n      _ended = 1;\n    });\n\n    const pathName: string = this._getStorage(name);\n\n    fs.access(pathName, fileNotFound => {\n      const exists = !fileNotFound;\n      if (exists) {\n        uploadStream.emit('error', fSError(fileExist));\n      } else {\n        const temporalName = path.join(this.path, `${name}.tmp-${String(Math.random()).replace(/^0\\./, '')}`);\n        debug('write a temporal name %o', temporalName);\n        const file = fs.createWriteStream(temporalName);\n        const removeTempFile = (): void => fs.unlink(temporalName, () => {});\n        let opened = false;\n        uploadStream.pipe(file);\n\n        uploadStream.done = function(): void {\n          const onend = function(): void {\n            file.on('close', function() {\n              renameTmp(temporalName, pathName, function(err) {\n                if (err) {\n                  uploadStream.emit('error', err);\n                } else {\n                  uploadStream.emit('success');\n                }\n              });\n            });\n            file.end();\n          };\n          if (_ended) {\n            onend();\n          } else {\n            uploadStream.on('end', onend);\n          }\n        };\n\n        uploadStream.abort = function(): void {\n          if (opened) {\n            opened = false;\n            file.on('close', function() {\n              removeTempFile();\n            });\n          } else {\n            // if the file does not recieve any byte never is opened and has to be removed anyway.\n            removeTempFile();\n          }\n          file.end();\n        };\n\n        file.on('open', function() {\n          opened = true;\n          // re-emitting open because it's handled in storage.js\n          uploadStream.emit('open');\n        });\n\n        file.on('error', function(err) {\n          uploadStream.emit('error', err);\n        });\n      }\n    });\n\n    return uploadStream;\n  }\n\n  public readTarball(name: string): ReadTarball {\n    const pathName: string = this._getStorage(name);\n    debug('read a a tarball %o on path %o', name, pathName);\n\n    const readTarballStream = new ReadTarball({});\n\n    const readStream = fs.createReadStream(pathName);\n\n    readStream.on('error', function(err) {\n      debug('error on read a tarball %o with error %o', name, err);\n      readTarballStream.emit('error', err);\n    });\n\n    readStream.on('open', function(fd) {\n      fs.fstat(fd, function(err, stats) {\n        if (_.isNil(err) === false) {\n          debug('error on read a tarball %o with error %o', name, err);\n          return readTarballStream.emit('error', err);\n        }\n        readTarballStream.emit('content-length', stats.size);\n        readTarballStream.emit('open');\n        debug('open on read a tarball %o', name);\n        readStream.pipe(readTarballStream);\n      });\n    });\n\n    readTarballStream.abort = function(): void {\n      debug('abort on read a tarball %o', name);\n      readStream.close();\n    };\n\n    return readTarballStream;\n  }\n\n  private _createFile(name: string, contents: any, callback: Function): void {\n    debug(' create a new file: %o', name);\n\n    fs.open(name, 'wx', err => {\n      if (err) {\n        // native EEXIST used here to check exception on fs.open\n        if (err.code === 'EEXIST') {\n          debug('file %o cannot be created, it already exists: %o', name);\n          return callback(fSError(fileExist));\n        }\n      }\n\n      this._writeFile(name, contents, callback);\n    });\n  }\n\n  private _readStorageFile(name: string): Promise<any> {\n    return new Promise((resolve, reject): void => {\n      debug('reading the file: %o', name);\n\n      fs.readFile(name, (err, data) => {\n        if (err) {\n          debug('error reading the file: %o with error %o', name, err);\n          reject(err);\n        } else {\n          debug('read file %o succeed', name);\n\n          resolve(data);\n        }\n      });\n    });\n  }\n\n  private _convertToString(value: Package): string {\n    return JSON.stringify(value, null, '\\t');\n  }\n\n  private _getStorage(fileName = ''): string {\n    const storagePath: string = path.join(this.path, fileName);\n\n    return storagePath;\n  }\n\n  private _writeFile(dest: string, data: string, cb: Callback): void {\n    const createTempFile = (cb): void => {\n      const tempFilePath = tempFile(dest);\n\n      fs.writeFile(tempFilePath, data, err => {\n        if (err) {\n          debug('error on write the file: %o', dest);\n          return cb(err);\n        }\n\n        debug('creating a new file:: %o', dest);\n        renameTmp(tempFilePath, dest, cb);\n      });\n    };\n\n    createTempFile(err => {\n      if (err && err.code === noSuchFile) {\n        mkdirp(path.dirname(dest))\n          .then(() => {\n            createTempFile(cb);\n          })\n          .catch(err => {\n            return cb(err);\n          });\n      } else {\n        cb(err);\n      }\n    });\n  }\n\n  private _lockAndReadJSON(name: string, cb: Function): void {\n    const fileName: string = this._getStorage(name);\n\n    readFile(\n      fileName,\n      {\n        lock: true,\n        parse: true,\n      },\n      (err, res) => {\n        if (err) {\n          debug('error on lock and read json for file: %o', name);\n\n          return cb(err);\n        }\n        debug('lock and read json for file: %o', name);\n\n        return cb(null, res);\n      }\n    );\n  }\n\n  private _unlockJSON(name: string, cb: Function): void {\n    unlockFile(this._getStorage(name), cb);\n  }\n}\n"],"mappings":"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"}