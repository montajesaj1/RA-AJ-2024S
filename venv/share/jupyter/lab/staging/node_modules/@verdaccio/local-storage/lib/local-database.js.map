{"version":3,"file":"local-database.js","names":["_fs","_interopRequireDefault","require","_path","_debug","_lodash","_async","_mkdirp","_commonsApi","_localFs","_interopRequireWildcard","_pkgUtils","_token","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","DEPRECATED_DB_NAME","DB_NAME","debug","buildDebug","LocalDatabase","TokenActions","constructor","config","logger","path","_buildStoragePath","locked","data","_fetchLocalPackages","_sync","getSecret","Promise","resolve","secret","setSecret","add","name","cb","list","indexOf","push","search","onPackage","onEnd","validateName","storages","_getCustomPackageLocalStorages","JSON","stringify","base","Path","dirname","self_path","self","storageKeys","keys","async","eachSeries","storage","position","base2","join","storagePath","fs","readdir","err","files","file","includes","match","fileLocation","file2","packagePath","stat","stats","_","isNil","item","time","mtime","getTime","remove","getInternalError","error","pkgName","splice","totalItems","length","getPackageStorage","packageName","packageAccess","getMatchedPackagesSpec","_getLocalStoragePath","undefined","isString","packageStoragePath","LocalDriver","clean","packages","listPackagesConf","map","pkg","Error","folderName","mkdirp","sync","writeFileSync","globalConfigStorage","sinopiadbPath","_dbGenPath","accessSync","constants","F_OK","process","emitWarning","code","detail","noSuchFile","emptyDatabase","loadPrivatePackages","message","_default","exports"],"sources":["../src/local-database.ts"],"sourcesContent":["import fs from 'fs';\nimport Path from 'path';\n\nimport buildDebug from 'debug';\nimport _ from 'lodash';\nimport async from 'async';\nimport mkdirp from 'mkdirp';\nimport {\n  Callback,\n  Config,\n  IPackageStorage,\n  IPluginStorage,\n  LocalStorage,\n  Logger,\n  StorageList,\n} from '@verdaccio/legacy-types';\nimport { getInternalError } from '@verdaccio/commons-api';\n\nimport LocalDriver, { noSuchFile } from './local-fs';\nimport { loadPrivatePackages } from './pkg-utils';\nimport TokenActions from './token';\n\nconst DEPRECATED_DB_NAME = '.sinopia-db.json';\nconst DB_NAME = '.verdaccio-db.json';\n\nconst debug = buildDebug('verdaccio:plugin:local-storage');\n\nclass LocalDatabase extends TokenActions implements IPluginStorage<{}> {\n  public path: string;\n  public logger: Logger;\n  public data: LocalStorage;\n  public config: Config;\n  public locked: boolean;\n\n  public constructor(config: Config, logger: Logger) {\n    super(config);\n    this.config = config;\n    this.path = this._buildStoragePath(config);\n    this.logger = logger;\n    this.locked = false;\n    this.data = this._fetchLocalPackages();\n    this._sync();\n  }\n\n  public getSecret(): Promise<string> {\n    return Promise.resolve(this.data.secret);\n  }\n\n  public setSecret(secret: string): Promise<Error | null> {\n    return new Promise((resolve): void => {\n      this.data.secret = secret;\n\n      resolve(this._sync());\n    });\n  }\n\n  public add(name: string, cb: Callback): void {\n    if (this.data.list.indexOf(name) === -1) {\n      this.data.list.push(name);\n\n      debug('the private package %o has been added', name);\n      cb(this._sync());\n    } else {\n      debug('the private package %o was not added', name);\n      cb(null);\n    }\n  }\n\n  public search(\n    onPackage: Callback,\n    onEnd: Callback,\n    validateName: (name: string) => boolean\n  ): void {\n    const storages = this._getCustomPackageLocalStorages();\n    debug(`search custom local packages: %o`, JSON.stringify(storages));\n    const base = Path.dirname(this.config.self_path);\n    const self = this;\n    const storageKeys = Object.keys(storages);\n    debug(`search base: %o keys: %o`, base, storageKeys);\n\n    async.eachSeries(\n      storageKeys,\n      function (storage, cb) {\n        const position = storageKeys.indexOf(storage);\n        const base2 = Path.join(position !== 0 ? storageKeys[0] : '');\n        const storagePath: string = Path.resolve(base, base2, storage);\n        debug('search path: %o : %o', storagePath, storage);\n        fs.readdir(storagePath, (err, files) => {\n          if (err) {\n            return cb(err);\n          }\n\n          async.eachSeries(\n            files,\n            function (file, cb) {\n              debug('local-storage: [search] search file path: %o', file);\n              if (storageKeys.includes(file)) {\n                return cb();\n              }\n\n              if (file.match(/^@/)) {\n                // scoped\n                const fileLocation = Path.resolve(base, storage, file);\n                debug('search scoped file location: %o', fileLocation);\n                fs.readdir(fileLocation, function (err, files) {\n                  if (err) {\n                    return cb(err);\n                  }\n\n                  async.eachSeries(\n                    files,\n                    (file2, cb) => {\n                      if (validateName(file2)) {\n                        const packagePath = Path.resolve(base, storage, file, file2);\n\n                        fs.stat(packagePath, (err, stats) => {\n                          if (_.isNil(err) === false) {\n                            return cb(err);\n                          }\n                          const item = {\n                            name: `${file}/${file2}`,\n                            path: packagePath,\n                            time: stats.mtime.getTime(),\n                          };\n                          onPackage(item, cb);\n                        });\n                      } else {\n                        cb();\n                      }\n                    },\n                    cb\n                  );\n                });\n              } else if (validateName(file)) {\n                const base2 = Path.join(position !== 0 ? storageKeys[0] : '');\n                const packagePath = Path.resolve(base, base2, storage, file);\n                debug('search file location: %o', packagePath);\n                fs.stat(packagePath, (err, stats) => {\n                  if (_.isNil(err) === false) {\n                    return cb(err);\n                  }\n                  onPackage(\n                    {\n                      name: file,\n                      path: packagePath,\n                      time: self.getTime(stats.mtime.getTime(), stats.mtime),\n                    },\n                    cb\n                  );\n                });\n              } else {\n                cb();\n              }\n            },\n            cb\n          );\n        });\n      },\n      // @ts-ignore\n      onEnd\n    );\n  }\n\n  public remove(name: string, cb: Callback): void {\n    this.get((err, data) => {\n      if (err) {\n        cb(getInternalError('error remove private package'));\n        this.logger.error(\n          { err },\n          '[local-storage/remove]: remove the private package has failed @{err}'\n        );\n        debug('error on remove package %o', name);\n      }\n\n      const pkgName = data.indexOf(name);\n      if (pkgName !== -1) {\n        this.data.list.splice(pkgName, 1);\n\n        debug('remove package %o has been removed', name);\n      }\n\n      cb(this._sync());\n    });\n  }\n\n  /**\n   * Return all database elements.\n   * @return {Array}\n   */\n  public get(cb: Callback): void {\n    const list = this.data.list;\n    const totalItems = this.data.list.length;\n\n    cb(null, list);\n\n    debug('get full list of packages (%o) has been fetched', totalItems);\n  }\n\n  public getPackageStorage(packageName: string): IPackageStorage {\n    const packageAccess = this.config.getMatchedPackagesSpec(packageName);\n\n    const packagePath: string = this._getLocalStoragePath(\n      packageAccess ? packageAccess.storage : undefined\n    );\n    debug('storage path selected: ', packagePath);\n\n    if (_.isString(packagePath) === false) {\n      debug('the package %o has no storage defined ', packageName);\n      return;\n    }\n\n    const packageStoragePath: string = Path.join(\n      Path.resolve(Path.dirname(this.config.self_path || ''), packagePath),\n      packageName\n    );\n\n    debug('storage absolute path: ', packageStoragePath);\n\n    return new LocalDriver(packageStoragePath, this.logger);\n  }\n\n  public clean(): void {\n    this._sync();\n  }\n\n  private getTime(time: number, mtime: Date): number | Date {\n    return time ? time : mtime;\n  }\n\n  private _getCustomPackageLocalStorages(): object {\n    const storages = {};\n\n    // add custom storage if exist\n    if (this.config.storage) {\n      storages[this.config.storage] = true;\n    }\n\n    const { packages } = this.config;\n\n    if (packages) {\n      const listPackagesConf = Object.keys(packages || {});\n\n      listPackagesConf.map((pkg) => {\n        const storage = packages[pkg].storage;\n        if (storage) {\n          storages[storage] = false;\n        }\n      });\n    }\n\n    return storages;\n  }\n\n  /**\n   * Syncronize {create} database whether does not exist.\n   * @return {Error|*}\n   */\n  private _sync(): Error | null {\n    debug('sync database started');\n\n    if (this.locked) {\n      this.logger.error(\n        'Database is locked, please check error message printed during startup to ' +\n          'prevent data loss.'\n      );\n      return new Error(\n        'Verdaccio database is locked, please contact your administrator to checkout ' +\n          'logs during verdaccio startup.'\n      );\n    }\n    // Uses sync to prevent ugly race condition\n    try {\n      // https://www.npmjs.com/package/mkdirp#mkdirpsyncdir-opts\n      const folderName = Path.dirname(this.path);\n      mkdirp.sync(folderName);\n      debug('sync folder %o created succeed', folderName);\n    } catch (err) {\n      debug('sync create folder has failed with error: %o', err);\n      return null;\n    }\n\n    try {\n      fs.writeFileSync(this.path, JSON.stringify(this.data));\n      debug('sync write succeed');\n\n      return null;\n    } catch (err: any) {\n      debug('sync failed %o', err);\n\n      return err;\n    }\n  }\n\n  /**\n   * Verify the right local storage location.\n   * @param {String} path\n   * @return {String}\n   * @private\n   */\n  private _getLocalStoragePath(storage: string | void): string {\n    const globalConfigStorage = this.config ? this.config.storage : undefined;\n    if (_.isNil(globalConfigStorage)) {\n      throw new Error('global storage is required for this plugin');\n    } else {\n      if (_.isNil(storage) === false && _.isString(storage)) {\n        return Path.join(globalConfigStorage as string, storage as string);\n      }\n\n      return globalConfigStorage as string;\n    }\n  }\n\n  /**\n   * Build the local database path.\n   * @param {Object} config\n   * @return {string|String|*}\n   * @private\n   */\n  private _buildStoragePath(config: Config): string {\n    const sinopiadbPath: string = this._dbGenPath(DEPRECATED_DB_NAME, config);\n    try {\n      fs.accessSync(sinopiadbPath, fs.constants.F_OK);\n      // @ts-ignore\n      process.emitWarning('Database name deprecated!', {\n        code: 'VERCODE01',\n        detail: `Please rename database name from ${DEPRECATED_DB_NAME} to ${DB_NAME}`,\n      });\n      return sinopiadbPath;\n    } catch (err: any) {\n      if (err.code === noSuchFile) {\n        return this._dbGenPath(DB_NAME, config);\n      }\n\n      throw err;\n    }\n  }\n\n  /**\n   * Fetch local packages.\n   * @private\n   * @return {Object}\n   */\n  private _fetchLocalPackages(): LocalStorage {\n    const list: StorageList = [];\n    const emptyDatabase = { list, secret: '' };\n\n    try {\n      return loadPrivatePackages(this.path, this.logger);\n    } catch (err: any) {\n      // readFileSync is platform specific, macOS, Linux and Windows thrown an error\n      // Only recreate if file not found to prevent data loss\n      if (err.code !== noSuchFile) {\n        this.locked = true;\n        this.logger.error(\n          'Failed to read package database file, please check the error printed below:\\n',\n          `File Path: ${this.path}\\n\\n ${err.message}`\n        );\n      }\n\n      return emptyDatabase;\n    }\n  }\n}\n\nexport default LocalDatabase;\n"],"mappings":"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"}