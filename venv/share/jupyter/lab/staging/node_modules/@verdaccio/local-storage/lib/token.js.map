{"version":3,"file":"token.js","names":["_path","_interopRequireDefault","require","_lodash","_lowdb","_FileAsync","_Memory","_debug","obj","__esModule","default","debug","buildDebug","TOKEN_DB_NAME","TokenActions","constructor","config","tokenDb","_dbGenPath","dbName","Path","join","resolve","dirname","self_path","storage","getTokenDb","adapter","process","env","NODE_ENV","FileMemory","pathDb","FileAsync","low","saveToken","token","key","db","userData","get","user","value","_","isNil","set","write","push","getState","deleteToken","tokenKey","userTokens","Error","length","remainingTokens","filter","readTokens","tokens","exports"],"sources":["../src/token.ts"],"sourcesContent":["import Path from 'path';\n\nimport _ from 'lodash';\nimport low from 'lowdb';\nimport FileAsync from 'lowdb/adapters/FileAsync';\nimport FileMemory from 'lowdb/adapters/Memory';\nimport buildDebug from 'debug';\nimport { ITokenActions, Config, Token, TokenFilter } from '@verdaccio/legacy-types';\n\nconst debug = buildDebug('verdaccio:plugin:local-storage:token');\n\nconst TOKEN_DB_NAME = '.token-db.json';\n\nexport default class TokenActions implements ITokenActions {\n  public config: Config;\n  public tokenDb: low.LowdbAsync<any> | null;\n\n  public constructor(config: Config) {\n    this.config = config;\n    this.tokenDb = null;\n  }\n\n  public _dbGenPath(dbName: string, config: Config): string {\n    return Path.join(\n      Path.resolve(Path.dirname(config.self_path || ''), config.storage as string, dbName)\n    );\n  }\n\n  private async getTokenDb(): Promise<low.LowdbAsync<any>> {\n    if (!this.tokenDb) {\n      debug('token database is not defined');\n      let adapter;\n      if (process.env.NODE_ENV === 'test') {\n        debug('token memory adapter');\n        adapter = new FileMemory('');\n      } else {\n        debug('token async adapter');\n        const pathDb = this._dbGenPath(TOKEN_DB_NAME, this.config);\n        adapter = new FileAsync(pathDb);\n      }\n      debug('token bd generated');\n      this.tokenDb = await low(adapter);\n    }\n\n    return this.tokenDb;\n  }\n\n  public async saveToken(token: Token): Promise<void> {\n    debug('token key %o', token.key);\n    const db = await this.getTokenDb();\n    const userData = await db.get(token.user).value();\n    debug('user data %o', userData);\n    if (_.isNil(userData)) {\n      await db.set(token.user, [token]).write();\n      debug('token user %o new database', token.user);\n    } else {\n      // types does not match with valid implementation\n      // @ts-ignore\n      await db\n        .get(token.user)\n        // @ts-ignore\n        .push(token)\n        .write();\n    }\n    debug('data %o', await db.getState());\n    debug('token saved %o', token.user);\n  }\n\n  public async deleteToken(user: string, tokenKey: string): Promise<void> {\n    const db = await this.getTokenDb();\n    const userTokens = await db.get(user).value();\n    if (_.isNil(userTokens)) {\n      throw new Error('user not found');\n    }\n    debug('tokens %o - %o', userTokens, userTokens.length);\n    const remainingTokens = userTokens.filter(({ key }) => {\n      debug('key %o', key);\n      return key !== tokenKey;\n    });\n    await db.set(user, remainingTokens).write();\n    debug('removed tokens key %o', tokenKey);\n  }\n\n  public async readTokens(filter: TokenFilter): Promise<Token[]> {\n    const { user } = filter;\n    debug('read tokens with %o', user);\n    const db = await this.getTokenDb();\n    const tokens = await db.get(user).value();\n    return tokens || [];\n  }\n}\n"],"mappings":"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"}