"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = loadPlugin;
var _debug = _interopRequireDefault(require("debug"));
var _lodash = _interopRequireDefault(require("lodash"));
var _path = _interopRequireDefault(require("path"));
var _constants = require("./constants");
var _logger = require("./logger");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
const debug = (0, _debug.default)('verdaccio:plugin:loader');

/**
 * Requires a module.
 * @param {*} path the module's path
 * @return {Object}
 */
function tryLoad(path) {
  try {
    debug('loading plugin %s', path);
    return require(path);
  } catch (err) {
    if (err.code === _constants.MODULE_NOT_FOUND) {
      debug('plugin %s not found', path);
      return null;
    }
    _logger.logger.error({
      err: err.msg
    }, 'error loading plugin @{err}');
    throw err;
  }
}
function mergeConfig(appConfig, pluginConfig) {
  return _lodash.default.merge(appConfig, pluginConfig);
}
function isValid(plugin) {
  return _lodash.default.isFunction(plugin) || _lodash.default.isFunction(plugin.default);
}
function isES6(plugin) {
  return Object.keys(plugin).includes('default');
}

// export type PluginGeneric<R, T extends IPlugin<R> = ;

/**
 * Load a plugin following the rules
 * - First try to load from the internal directory plugins (which will disappear soon or later).
 * - If the package is scoped eg: @scope/foo, try to load as a package
 * - A second attempt from the external plugin directory
 * - A third attempt from node_modules, in case to have multiple match as for instance verdaccio-ldap
 * and sinopia-ldap. All verdaccio prefix will have preferences.
 * @param {*} config a reference of the configuration settings
 * @param {*} pluginConfigs
 * @param {*} params a set of params to initialize the plugin
 * @param {*} sanityCheck callback that check the shape that should fulfill the plugin
 * @return {Array} list of plugins
 */
function loadPlugin(config, pluginConfigs = {}, params, sanityCheck, prefix = 'verdaccio') {
  return Object.keys(pluginConfigs).map(pluginId => {
    let plugin;
    const isScoped = pluginId.startsWith('@') && pluginId.includes('/');
    debug('isScoped %s', isScoped);
    if (isScoped) {
      plugin = tryLoad(pluginId);
    }
    const localPlugin = _path.default.resolve(__dirname + '/../plugins', pluginId);
    // try local plugins first
    plugin = tryLoad(localPlugin);

    // try the external plugin directory
    if (plugin === null && config.plugins) {
      const pluginDir = config.plugins;
      const externalFilePlugin = _path.default.resolve(pluginDir, pluginId);
      plugin = tryLoad(externalFilePlugin);

      // npm package
      if (plugin === null && pluginId.match(/^[^\.\/]/)) {
        plugin = tryLoad(_path.default.resolve(pluginDir, `${prefix}-${pluginId}`));
        // compatibility for old sinopia plugins
        if (!plugin) {
          plugin = tryLoad(_path.default.resolve(pluginDir, `sinopia-${pluginId}`));
          if (plugin) {
            _logger.logger.warn({
              name: pluginId
            }, `plugin names that start with sinopia-* will be removed in the future, please rename package to verdaccio-*`);
          }
        }
      }
    }

    // npm package
    if (plugin === null && pluginId.match(/^[^\.\/]/)) {
      plugin = tryLoad(`${prefix}-${pluginId}`);
      // compatibility for old sinopia plugins
      if (!plugin) {
        plugin = tryLoad(`sinopia-${pluginId}`);
      }
      if (plugin) {
        debug('plugin %s is an npm package', pluginId);
      }
    }
    if (plugin === null) {
      plugin = tryLoad(pluginId);
    }

    // relative to config path
    if (plugin === null && pluginId.match(/^\.\.?($|\/)/)) {
      var _config$self_path;
      // compatible with 6.x
      plugin = tryLoad(_path.default.resolve(_path.default.dirname((_config$self_path = config.self_path) !== null && _config$self_path !== void 0 ? _config$self_path : config.configPath), pluginId));
    }
    if (plugin === null) {
      if (isScoped) {
        _logger.logger.error({
          content: pluginId
        }, 'plugin not found. try npm install @{content}');
      } else {
        _logger.logger.error({
          content: pluginId,
          prefix
        }, 'plugin not found. try npm install @{prefix}-@{content}');
      }
      const msg = isScoped ? `
      ${pluginId} plugin not found. try "npm install ${pluginId}"` : `
      ${prefix}-${pluginId} plugin not found. try "npm install ${prefix}-${pluginId}"`;
      throw Error(msg);
    }
    if (!isValid(plugin)) {
      _logger.logger.error({
        content: pluginId
      }, '@{prefix}-@{content} plugin does not have the right code structure');
      throw Error(`"${pluginId}" plugin does not have the right code structure`);
    }

    /* eslint new-cap:off */
    try {
      if (isES6(plugin)) {
        debug('plugin is ES6');
        plugin = new plugin.default(mergeConfig(config, pluginConfigs[pluginId]), params);
      } else {
        debug('plugin is commonJS');
        plugin = plugin(pluginConfigs[pluginId], params);
      }
    } catch (error) {
      plugin = null;
      _logger.logger.error({
        error,
        pluginId
      }, 'error loading a plugin @{pluginId}: @{error}');
    }
    /* eslint new-cap:off */

    if (plugin === null || !sanityCheck(plugin)) {
      if (isScoped) {
        _logger.logger.error({
          content: pluginId
        }, "@{content} doesn't look like a valid plugin");
      } else {
        _logger.logger.error({
          content: pluginId,
          prefix
        }, "@{prefix}-@{content} doesn't look like a valid plugin");
      }
      throw Error(`sanity check has failed, "${pluginId}" is not a valid plugin`);
    }
    if (isScoped) {
      _logger.logger.info({
        content: pluginId
      }, 'plugin successfully loaded: @{content}');
    } else {
      _logger.logger.info({
        content: pluginId,
        prefix
      }, 'plugin successfully loaded: @{prefix}-@{content}');
    }
    return plugin;
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZGVidWciLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9sb2Rhc2giLCJfcGF0aCIsIl9jb25zdGFudHMiLCJfbG9nZ2VyIiwib2JqIiwiX19lc01vZHVsZSIsImRlZmF1bHQiLCJkZWJ1ZyIsImJ1aWxkRGVidWciLCJ0cnlMb2FkIiwicGF0aCIsImVyciIsImNvZGUiLCJNT0RVTEVfTk9UX0ZPVU5EIiwibG9nZ2VyIiwiZXJyb3IiLCJtc2ciLCJtZXJnZUNvbmZpZyIsImFwcENvbmZpZyIsInBsdWdpbkNvbmZpZyIsIl8iLCJtZXJnZSIsImlzVmFsaWQiLCJwbHVnaW4iLCJpc0Z1bmN0aW9uIiwiaXNFUzYiLCJPYmplY3QiLCJrZXlzIiwiaW5jbHVkZXMiLCJsb2FkUGx1Z2luIiwiY29uZmlnIiwicGx1Z2luQ29uZmlncyIsInBhcmFtcyIsInNhbml0eUNoZWNrIiwicHJlZml4IiwibWFwIiwicGx1Z2luSWQiLCJpc1Njb3BlZCIsInN0YXJ0c1dpdGgiLCJsb2NhbFBsdWdpbiIsIlBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwicGx1Z2lucyIsInBsdWdpbkRpciIsImV4dGVybmFsRmlsZVBsdWdpbiIsIm1hdGNoIiwid2FybiIsIm5hbWUiLCJfY29uZmlnJHNlbGZfcGF0aCIsImRpcm5hbWUiLCJzZWxmX3BhdGgiLCJjb25maWdQYXRoIiwiY29udGVudCIsIkVycm9yIiwiaW5mbyJdLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvcGx1Z2luLWxvYWRlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYnVpbGREZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IFBhdGggZnJvbSAncGF0aCc7XG5cbmltcG9ydCB7IHBsdWdpblV0aWxzIH0gZnJvbSAnQHZlcmRhY2Npby9jb3JlJztcbmltcG9ydCB7IENvbmZpZyB9IGZyb20gJ0B2ZXJkYWNjaW8vdHlwZXMnO1xuXG5pbXBvcnQgeyBNT0RVTEVfTk9UX0ZPVU5EIH0gZnJvbSAnLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi9sb2dnZXInO1xuXG5jb25zdCBkZWJ1ZyA9IGJ1aWxkRGVidWcoJ3ZlcmRhY2NpbzpwbHVnaW46bG9hZGVyJyk7XG5cbi8qKlxuICogUmVxdWlyZXMgYSBtb2R1bGUuXG4gKiBAcGFyYW0geyp9IHBhdGggdGhlIG1vZHVsZSdzIHBhdGhcbiAqIEByZXR1cm4ge09iamVjdH1cbiAqL1xuZnVuY3Rpb24gdHJ5TG9hZChwYXRoOiBzdHJpbmcpOiBhbnkge1xuICB0cnkge1xuICAgIGRlYnVnKCdsb2FkaW5nIHBsdWdpbiAlcycsIHBhdGgpO1xuICAgIHJldHVybiByZXF1aXJlKHBhdGgpO1xuICB9IGNhdGNoIChlcnI6IGFueSkge1xuICAgIGlmIChlcnIuY29kZSA9PT0gTU9EVUxFX05PVF9GT1VORCkge1xuICAgICAgZGVidWcoJ3BsdWdpbiAlcyBub3QgZm91bmQnLCBwYXRoKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBsb2dnZXIuZXJyb3IoeyBlcnI6IGVyci5tc2cgfSwgJ2Vycm9yIGxvYWRpbmcgcGx1Z2luIEB7ZXJyfScpO1xuICAgIHRocm93IGVycjtcbiAgfVxufVxuXG5mdW5jdGlvbiBtZXJnZUNvbmZpZyhhcHBDb25maWcsIHBsdWdpbkNvbmZpZyk6IENvbmZpZyB7XG4gIHJldHVybiBfLm1lcmdlKGFwcENvbmZpZywgcGx1Z2luQ29uZmlnKTtcbn1cblxuZnVuY3Rpb24gaXNWYWxpZChwbHVnaW4pOiBib29sZWFuIHtcbiAgcmV0dXJuIF8uaXNGdW5jdGlvbihwbHVnaW4pIHx8IF8uaXNGdW5jdGlvbihwbHVnaW4uZGVmYXVsdCk7XG59XG5cbmZ1bmN0aW9uIGlzRVM2KHBsdWdpbik6IGJvb2xlYW4ge1xuICByZXR1cm4gT2JqZWN0LmtleXMocGx1Z2luKS5pbmNsdWRlcygnZGVmYXVsdCcpO1xufVxuXG4vLyBleHBvcnQgdHlwZSBQbHVnaW5HZW5lcmljPFIsIFQgZXh0ZW5kcyBJUGx1Z2luPFI+ID0gO1xuXG4vKipcbiAqIExvYWQgYSBwbHVnaW4gZm9sbG93aW5nIHRoZSBydWxlc1xuICogLSBGaXJzdCB0cnkgdG8gbG9hZCBmcm9tIHRoZSBpbnRlcm5hbCBkaXJlY3RvcnkgcGx1Z2lucyAod2hpY2ggd2lsbCBkaXNhcHBlYXIgc29vbiBvciBsYXRlcikuXG4gKiAtIElmIHRoZSBwYWNrYWdlIGlzIHNjb3BlZCBlZzogQHNjb3BlL2ZvbywgdHJ5IHRvIGxvYWQgYXMgYSBwYWNrYWdlXG4gKiAtIEEgc2Vjb25kIGF0dGVtcHQgZnJvbSB0aGUgZXh0ZXJuYWwgcGx1Z2luIGRpcmVjdG9yeVxuICogLSBBIHRoaXJkIGF0dGVtcHQgZnJvbSBub2RlX21vZHVsZXMsIGluIGNhc2UgdG8gaGF2ZSBtdWx0aXBsZSBtYXRjaCBhcyBmb3IgaW5zdGFuY2UgdmVyZGFjY2lvLWxkYXBcbiAqIGFuZCBzaW5vcGlhLWxkYXAuIEFsbCB2ZXJkYWNjaW8gcHJlZml4IHdpbGwgaGF2ZSBwcmVmZXJlbmNlcy5cbiAqIEBwYXJhbSB7Kn0gY29uZmlnIGEgcmVmZXJlbmNlIG9mIHRoZSBjb25maWd1cmF0aW9uIHNldHRpbmdzXG4gKiBAcGFyYW0geyp9IHBsdWdpbkNvbmZpZ3NcbiAqIEBwYXJhbSB7Kn0gcGFyYW1zIGEgc2V0IG9mIHBhcmFtcyB0byBpbml0aWFsaXplIHRoZSBwbHVnaW5cbiAqIEBwYXJhbSB7Kn0gc2FuaXR5Q2hlY2sgY2FsbGJhY2sgdGhhdCBjaGVjayB0aGUgc2hhcGUgdGhhdCBzaG91bGQgZnVsZmlsbCB0aGUgcGx1Z2luXG4gKiBAcmV0dXJuIHtBcnJheX0gbGlzdCBvZiBwbHVnaW5zXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGxvYWRQbHVnaW48VCBleHRlbmRzIHBsdWdpblV0aWxzLlBsdWdpbjxUPj4oXG4gIGNvbmZpZzogQ29uZmlnLFxuICBwbHVnaW5Db25maWdzOiBhbnkgPSB7fSxcbiAgcGFyYW1zOiBhbnksXG4gIHNhbml0eUNoZWNrOiBhbnksXG4gIHByZWZpeDogc3RyaW5nID0gJ3ZlcmRhY2Npbydcbik6IGFueVtdIHtcbiAgcmV0dXJuIE9iamVjdC5rZXlzKHBsdWdpbkNvbmZpZ3MpLm1hcCgocGx1Z2luSWQ6IHN0cmluZyk6IHBsdWdpblV0aWxzLlBsdWdpbjxUPiA9PiB7XG4gICAgbGV0IHBsdWdpbjtcbiAgICBjb25zdCBpc1Njb3BlZDogYm9vbGVhbiA9IHBsdWdpbklkLnN0YXJ0c1dpdGgoJ0AnKSAmJiBwbHVnaW5JZC5pbmNsdWRlcygnLycpO1xuICAgIGRlYnVnKCdpc1Njb3BlZCAlcycsIGlzU2NvcGVkKTtcbiAgICBpZiAoaXNTY29wZWQpIHtcbiAgICAgIHBsdWdpbiA9IHRyeUxvYWQocGx1Z2luSWQpO1xuICAgIH1cblxuICAgIGNvbnN0IGxvY2FsUGx1Z2luID0gUGF0aC5yZXNvbHZlKF9fZGlybmFtZSArICcvLi4vcGx1Z2lucycsIHBsdWdpbklkKTtcbiAgICAvLyB0cnkgbG9jYWwgcGx1Z2lucyBmaXJzdFxuICAgIHBsdWdpbiA9IHRyeUxvYWQobG9jYWxQbHVnaW4pO1xuXG4gICAgLy8gdHJ5IHRoZSBleHRlcm5hbCBwbHVnaW4gZGlyZWN0b3J5XG4gICAgaWYgKHBsdWdpbiA9PT0gbnVsbCAmJiBjb25maWcucGx1Z2lucykge1xuICAgICAgY29uc3QgcGx1Z2luRGlyID0gY29uZmlnLnBsdWdpbnM7XG4gICAgICBjb25zdCBleHRlcm5hbEZpbGVQbHVnaW4gPSBQYXRoLnJlc29sdmUocGx1Z2luRGlyLCBwbHVnaW5JZCk7XG4gICAgICBwbHVnaW4gPSB0cnlMb2FkKGV4dGVybmFsRmlsZVBsdWdpbik7XG5cbiAgICAgIC8vIG5wbSBwYWNrYWdlXG4gICAgICBpZiAocGx1Z2luID09PSBudWxsICYmIHBsdWdpbklkLm1hdGNoKC9eW15cXC5cXC9dLykpIHtcbiAgICAgICAgcGx1Z2luID0gdHJ5TG9hZChQYXRoLnJlc29sdmUocGx1Z2luRGlyLCBgJHtwcmVmaXh9LSR7cGx1Z2luSWR9YCkpO1xuICAgICAgICAvLyBjb21wYXRpYmlsaXR5IGZvciBvbGQgc2lub3BpYSBwbHVnaW5zXG4gICAgICAgIGlmICghcGx1Z2luKSB7XG4gICAgICAgICAgcGx1Z2luID0gdHJ5TG9hZChQYXRoLnJlc29sdmUocGx1Z2luRGlyLCBgc2lub3BpYS0ke3BsdWdpbklkfWApKTtcbiAgICAgICAgICBpZiAocGx1Z2luKSB7XG4gICAgICAgICAgICBsb2dnZXIud2FybihcbiAgICAgICAgICAgICAgeyBuYW1lOiBwbHVnaW5JZCB9LFxuICAgICAgICAgICAgICBgcGx1Z2luIG5hbWVzIHRoYXQgc3RhcnQgd2l0aCBzaW5vcGlhLSogd2lsbCBiZSByZW1vdmVkIGluIHRoZSBmdXR1cmUsIHBsZWFzZSByZW5hbWUgcGFja2FnZSB0byB2ZXJkYWNjaW8tKmBcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gbnBtIHBhY2thZ2VcbiAgICBpZiAocGx1Z2luID09PSBudWxsICYmIHBsdWdpbklkLm1hdGNoKC9eW15cXC5cXC9dLykpIHtcbiAgICAgIHBsdWdpbiA9IHRyeUxvYWQoYCR7cHJlZml4fS0ke3BsdWdpbklkfWApO1xuICAgICAgLy8gY29tcGF0aWJpbGl0eSBmb3Igb2xkIHNpbm9waWEgcGx1Z2luc1xuICAgICAgaWYgKCFwbHVnaW4pIHtcbiAgICAgICAgcGx1Z2luID0gdHJ5TG9hZChgc2lub3BpYS0ke3BsdWdpbklkfWApO1xuICAgICAgfVxuICAgICAgaWYgKHBsdWdpbikge1xuICAgICAgICBkZWJ1ZygncGx1Z2luICVzIGlzIGFuIG5wbSBwYWNrYWdlJywgcGx1Z2luSWQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChwbHVnaW4gPT09IG51bGwpIHtcbiAgICAgIHBsdWdpbiA9IHRyeUxvYWQocGx1Z2luSWQpO1xuICAgIH1cblxuICAgIC8vIHJlbGF0aXZlIHRvIGNvbmZpZyBwYXRoXG4gICAgaWYgKHBsdWdpbiA9PT0gbnVsbCAmJiBwbHVnaW5JZC5tYXRjaCgvXlxcLlxcLj8oJHxcXC8pLykpIHtcbiAgICAgIC8vIGNvbXBhdGlibGUgd2l0aCA2LnhcbiAgICAgIHBsdWdpbiA9IHRyeUxvYWQoUGF0aC5yZXNvbHZlKFBhdGguZGlybmFtZShjb25maWcuc2VsZl9wYXRoID8/IGNvbmZpZy5jb25maWdQYXRoKSwgcGx1Z2luSWQpKTtcbiAgICB9XG5cbiAgICBpZiAocGx1Z2luID09PSBudWxsKSB7XG4gICAgICBpZiAoaXNTY29wZWQpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKHsgY29udGVudDogcGx1Z2luSWQgfSwgJ3BsdWdpbiBub3QgZm91bmQuIHRyeSBucG0gaW5zdGFsbCBAe2NvbnRlbnR9Jyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIuZXJyb3IoXG4gICAgICAgICAgeyBjb250ZW50OiBwbHVnaW5JZCwgcHJlZml4IH0sXG4gICAgICAgICAgJ3BsdWdpbiBub3QgZm91bmQuIHRyeSBucG0gaW5zdGFsbCBAe3ByZWZpeH0tQHtjb250ZW50fSdcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG1zZyA9IGlzU2NvcGVkXG4gICAgICAgID8gYFxuICAgICAgJHtwbHVnaW5JZH0gcGx1Z2luIG5vdCBmb3VuZC4gdHJ5IFwibnBtIGluc3RhbGwgJHtwbHVnaW5JZH1cImBcbiAgICAgICAgOiBgXG4gICAgICAke3ByZWZpeH0tJHtwbHVnaW5JZH0gcGx1Z2luIG5vdCBmb3VuZC4gdHJ5IFwibnBtIGluc3RhbGwgJHtwcmVmaXh9LSR7cGx1Z2luSWR9XCJgO1xuICAgICAgdGhyb3cgRXJyb3IobXNnKTtcbiAgICB9XG5cbiAgICBpZiAoIWlzVmFsaWQocGx1Z2luKSkge1xuICAgICAgbG9nZ2VyLmVycm9yKFxuICAgICAgICB7IGNvbnRlbnQ6IHBsdWdpbklkIH0sXG4gICAgICAgICdAe3ByZWZpeH0tQHtjb250ZW50fSBwbHVnaW4gZG9lcyBub3QgaGF2ZSB0aGUgcmlnaHQgY29kZSBzdHJ1Y3R1cmUnXG4gICAgICApO1xuICAgICAgdGhyb3cgRXJyb3IoYFwiJHtwbHVnaW5JZH1cIiBwbHVnaW4gZG9lcyBub3QgaGF2ZSB0aGUgcmlnaHQgY29kZSBzdHJ1Y3R1cmVgKTtcbiAgICB9XG5cbiAgICAvKiBlc2xpbnQgbmV3LWNhcDpvZmYgKi9cbiAgICB0cnkge1xuICAgICAgaWYgKGlzRVM2KHBsdWdpbikpIHtcbiAgICAgICAgZGVidWcoJ3BsdWdpbiBpcyBFUzYnKTtcbiAgICAgICAgcGx1Z2luID0gbmV3IHBsdWdpbi5kZWZhdWx0KG1lcmdlQ29uZmlnKGNvbmZpZywgcGx1Z2luQ29uZmlnc1twbHVnaW5JZF0pLCBwYXJhbXMpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZGVidWcoJ3BsdWdpbiBpcyBjb21tb25KUycpO1xuICAgICAgICBwbHVnaW4gPSBwbHVnaW4ocGx1Z2luQ29uZmlnc1twbHVnaW5JZF0sIHBhcmFtcyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcGx1Z2luID0gbnVsbDtcbiAgICAgIGxvZ2dlci5lcnJvcih7IGVycm9yLCBwbHVnaW5JZCB9LCAnZXJyb3IgbG9hZGluZyBhIHBsdWdpbiBAe3BsdWdpbklkfTogQHtlcnJvcn0nKTtcbiAgICB9XG4gICAgLyogZXNsaW50IG5ldy1jYXA6b2ZmICovXG5cbiAgICBpZiAocGx1Z2luID09PSBudWxsIHx8ICFzYW5pdHlDaGVjayhwbHVnaW4pKSB7XG4gICAgICBpZiAoaXNTY29wZWQpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKHsgY29udGVudDogcGx1Z2luSWQgfSwgXCJAe2NvbnRlbnR9IGRvZXNuJ3QgbG9vayBsaWtlIGEgdmFsaWQgcGx1Z2luXCIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKFxuICAgICAgICAgIHsgY29udGVudDogcGx1Z2luSWQsIHByZWZpeCB9LFxuICAgICAgICAgIFwiQHtwcmVmaXh9LUB7Y29udGVudH0gZG9lc24ndCBsb29rIGxpa2UgYSB2YWxpZCBwbHVnaW5cIlxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgdGhyb3cgRXJyb3IoYHNhbml0eSBjaGVjayBoYXMgZmFpbGVkLCBcIiR7cGx1Z2luSWR9XCIgaXMgbm90IGEgdmFsaWQgcGx1Z2luYCk7XG4gICAgfVxuXG4gICAgaWYgKGlzU2NvcGVkKSB7XG4gICAgICBsb2dnZXIuaW5mbyh7IGNvbnRlbnQ6IHBsdWdpbklkIH0sICdwbHVnaW4gc3VjY2Vzc2Z1bGx5IGxvYWRlZDogQHtjb250ZW50fScpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dnZXIuaW5mbyhcbiAgICAgICAgeyBjb250ZW50OiBwbHVnaW5JZCwgcHJlZml4IH0sXG4gICAgICAgICdwbHVnaW4gc3VjY2Vzc2Z1bGx5IGxvYWRlZDogQHtwcmVmaXh9LUB7Y29udGVudH0nXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gcGx1Z2luO1xuICB9KTtcbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBQUEsTUFBQSxHQUFBQyxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUMsT0FBQSxHQUFBRixzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUUsS0FBQSxHQUFBSCxzQkFBQSxDQUFBQyxPQUFBO0FBS0EsSUFBQUcsVUFBQSxHQUFBSCxPQUFBO0FBQ0EsSUFBQUksT0FBQSxHQUFBSixPQUFBO0FBQWtDLFNBQUFELHVCQUFBTSxHQUFBLFdBQUFBLEdBQUEsSUFBQUEsR0FBQSxDQUFBQyxVQUFBLEdBQUFELEdBQUEsS0FBQUUsT0FBQSxFQUFBRixHQUFBO0FBRWxDLE1BQU1HLEtBQUssR0FBRyxJQUFBQyxjQUFVLEVBQUMseUJBQXlCLENBQUM7O0FBRW5EO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTQyxPQUFPQSxDQUFDQyxJQUFZLEVBQU87RUFDbEMsSUFBSTtJQUNGSCxLQUFLLENBQUMsbUJBQW1CLEVBQUVHLElBQUksQ0FBQztJQUNoQyxPQUFPWCxPQUFPLENBQUNXLElBQUks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